---
// Interactive GNS3-style network topology diagram showing Kubernetes pods
import portfolioData from '../../portfolio-data.json';

const { nodes: physicalNodes } = portfolioData.network_topology;

// Transform physical nodes and their services into a pod-centric topology
const pods = [];
const connections = [];
let nodeId = 1;

// Extract all pods/services from physical nodes
physicalNodes.forEach(physNode => {
  if (physNode.services) {
    physNode.services.forEach(service => {
      // Skip generic services, focus on actual pods
      if (service.name !== 'General Compute Workloads' && service.name !== 'Storage Workloads') {
        pods.push({
          id: nodeId++,
          label: service.name,
          group: getServiceGroup(service.name),
          physicalNode: physNode.label,
          physicalNodeColor: physNode.color,
          port: service.port,
          url: service.url,
          description: service.description,
          hostIP: physNode.ip
        });
      }
    });
  }
});

// Create connections based on Kubernetes architecture
// Prometheus scrapes Node Exporters
const prometheus = pods.find(p => p.label === 'Prometheus');
const nodeExporters = pods.filter(p => p.label === 'Node Exporter');
if (prometheus && nodeExporters.length > 0) {
  nodeExporters.forEach(exporter => {
    connections.push({
      from: prometheus.id,
      to: exporter.id,
      label: 'scrape',
      color: '#16a34a',
      dashes: true
    });
  });
}

// Promtails send logs to Loki
const loki = pods.find(p => p.label === 'Loki');
const promtails = pods.filter(p => p.label === 'Promtail');
if (loki && promtails.length > 0) {
  promtails.forEach(promtail => {
    connections.push({
      from: promtail.id,
      to: loki.id,
      label: 'logs',
      color: '#ea580c',
      dashes: true
    });
  });
}

// Grafana queries Prometheus and Loki
const grafana = pods.find(p => p.label === 'Grafana');
if (grafana && prometheus) {
  connections.push({
    from: grafana.id,
    to: prometheus.id,
    label: 'query',
    color: '#f59e0b',
    dashes: [5, 5]
  });
}
if (grafana && loki) {
  connections.push({
    from: grafana.id,
    to: loki.id,
    label: 'query',
    color: '#f59e0b',
    dashes: [5, 5]
  });
}

// All pods connect to API Server
const apiServer = pods.find(p => p.label === 'Kubernetes API Server');
if (apiServer) {
  pods.forEach(pod => {
    if (pod.label !== 'Kubernetes API Server' && pod.label !== 'etcd') {
      connections.push({
        from: pod.id,
        to: apiServer.id,
        label: '',
        color: '#64748b',
        width: 1
      });
    }
  });
}

// API Server connects to etcd
const etcd = pods.find(p => p.label === 'etcd');
if (apiServer && etcd) {
  connections.push({
    from: apiServer.id,
    to: etcd.id,
    label: 'state',
    color: '#2563eb',
    width: 3
  });
}

// CoreDNS provides DNS for all pods
const coreDNS = pods.find(p => p.label === 'CoreDNS');
if (coreDNS) {
  pods.forEach(pod => {
    if (pod.label !== 'CoreDNS' && pod.label !== 'Kubernetes API Server' && pod.label !== 'etcd') {
      connections.push({
        from: pod.id,
        to: coreDNS.id,
        label: '',
        color: '#8b5cf6',
        width: 1,
        dashes: [2, 4]
      });
    }
  });
}

function getServiceGroup(serviceName) {
  const controlPlane = ['Kubernetes API Server', 'etcd', 'CoreDNS'];
  const monitoring = ['Prometheus', 'Grafana', 'Loki'];
  const agents = ['Node Exporter', 'Promtail'];
  const applications = ['Jellyfin'];
  
  if (controlPlane.includes(serviceName)) return 'control-plane';
  if (monitoring.includes(serviceName)) return 'monitoring';
  if (agents.includes(serviceName)) return 'agent';
  if (applications.includes(serviceName)) return 'application';
  return 'workload';
}
---

<section id="homelab">
  <h2>Homelab Network Topology</h2>
  <div class="topology-container">
    <div class="topology-header">
      <p>Interactive Kubernetes pod topology showing services and their connections across the 3-node VMStation cluster</p>
      <div class="topology-controls">
        <button id="resetView" class="btn-small">Reset View</button>
        <button id="togglePhysics" class="btn-small">Toggle Physics</button>
      </div>
    </div>
    <div id="network-topology" class="network-diagram"></div>
    <div id="node-info" class="node-info-panel">
      <h3>Select a node to view details</h3>
      <p>Click on any server or device in the topology to see specifications and role information.</p>
    </div>
    <div class="topology-legend">
      <h4>Pod Types:</h4>
      <div class="legend-items">
        <div class="legend-item">
          <span class="legend-color" style="background: #2563eb;"></span>
          <span>Control Plane (API Server, etcd, CoreDNS)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #16a34a;"></span>
          <span>Monitoring (Prometheus, Grafana, Loki)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #8b5cf6;"></span>
          <span>Agents (Node Exporter, Promtail)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #ea580c;"></span>
          <span>Applications (Jellyfin, etc.)</span>
        </div>
      </div>
      <div style="margin-top: 1rem;">
        <h4>Physical Nodes:</h4>
        <div class="legend-items">
          <div class="legend-item">
            <div style="width: 20px; height: 20px; background: #2563eb; opacity: 0.2; border-radius: 3px;"></div>
            <span>masternode (192.168.4.63) - Always On</span>
          </div>
          <div class="legend-item">
            <div style="width: 20px; height: 20px; background: #16a34a; opacity: 0.2; border-radius: 3px;"></div>
            <span>storagenodet3500 (192.168.4.61) - Auto-Sleep</span>
          </div>
          <div class="legend-item">
            <div style="width: 20px; height: 20px; background: #ea580c; opacity: 0.2; border-radius: 3px;"></div>
            <span>homelab (192.168.4.62) - Auto-Sleep</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .topology-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-base);
    border-radius: var(--radius-md);
    padding: var(--space-6);
    margin-bottom: var(--space-4);
  }
  
  .topology-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
    gap: var(--space-4);
  }
  
  .topology-header p {
    color: var(--text-muted);
    margin: 0;
  }
  
  .topology-controls {
    display: flex;
    gap: var(--space-2);
  }
  
  .btn-small {
    padding: var(--space-2) var(--space-4);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-base);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: var(--transition-all);
  }
  
  .btn-small:hover {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
  }
  
  .network-diagram {
    width: 100%;
    height: 600px;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-base);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
  }
  
  .node-info-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-base);
    border-radius: var(--radius-md);
    padding: var(--space-8);
    min-height: 150px;
    margin-bottom: var(--space-4);
  }
  
  .node-info-panel h3 {
    color: var(--text-primary);
    margin-bottom: var(--space-3);
    font-size: var(--text-2xl);
    font-weight: var(--font-semibold);
  }
  
  .node-info-panel p {
    color: var(--text-muted);
    margin-bottom: var(--space-3);
  }
  
  .node-info-panel .specs {
    margin-top: var(--space-6);
  }
  
  .node-info-panel .specs strong {
    color: var(--color-primary);
  }
  
  .node-info-panel .repo-link {
    margin-top: var(--space-4);
    display: inline-block;
  }
  
  .topology-legend {
    background: var(--bg-secondary);
    border: 1px solid var(--border-base);
    border-radius: var(--radius-md);
    padding: var(--space-6);
  }
  
  .topology-legend h4 {
    color: var(--text-primary);
    margin-bottom: var(--space-4);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
  }
  
  .legend-items {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }
  
  .legend-color {
    width: 20px;
    height: 20px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-base);
  }
  
  @media (max-width: 768px) {
    .network-diagram {
      height: 400px;
    }
    
    .topology-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .topology-controls {
      width: 100%;
      justify-content: flex-start;
    }
    
    .btn-small {
      flex: 1;
    }
  }
</style>

<script>
  import { Network } from 'vis-network/standalone';
  
  // Store Network class globally for use in the data script
  window.VisNetwork = Network;
  // Dispatch event to signal that vis-network is loaded
  window.dispatchEvent(new Event('visNetworkLoaded'));
</script>

<script define:vars={{ pods, connections, physicalNodes }}>
  // Wait for vis-network to load
  function initializeTopology() {
    const Network = window.VisNetwork;
    
    if (!Network) {
      console.error('VisNetwork not loaded yet');
      return;
    }
  
  // Transform pods to vis-network format
  const nodes = pods.map(pod => ({
    id: pod.id,
    label: pod.label,
    group: pod.group,
    title: `${pod.label}\nHost: ${pod.physicalNode}\nIP: ${pod.hostIP}${pod.port ? '\nPort: ' + pod.port : ''}`,
    physicalNode: pod.physicalNode,
    physicalNodeColor: pod.physicalNodeColor,
    port: pod.port,
    url: pod.url,
    description: pod.description,
    hostIP: pod.hostIP
  }));
  
  // Transform connections to vis-network format
  const edges = connections.map(conn => {
    const edgeConfig = {
      from: conn.from,
      to: conn.to,
      label: conn.label || '',
      color: { color: conn.color || '#94a3b8' },
      width: conn.width || 2
    };
    
    if (conn.dashes) {
      edgeConfig.dashes = Array.isArray(conn.dashes) ? conn.dashes : true;
    }
    
    return edgeConfig;
  });
  
  // Create nodes for vis-network
  const visNodes = nodes.map(node => ({
    id: node.id,
    label: node.label,
    title: node.title,
    group: node.group,
    font: { color: '#ffffff', size: 14 },
    specs: node.specs
  }));
  
  // Network configuration
  const container = document.getElementById('network-topology');
  const data = {
    nodes: visNodes,
    edges: edges
  };
  
  const options = {
    nodes: {
      shape: 'box',
      margin: 10,
      widthConstraint: {
        minimum: 100,
        maximum: 150
      },
      font: {
        color: '#1e293b',
        size: 14,
        face: 'Inter, system-ui, sans-serif'
      },
      borderWidth: 2,
      borderWidthSelected: 3,
      shadow: {
        enabled: true,
        color: 'rgba(0, 0, 0, 0.1)',
        size: 10,
        x: 0,
        y: 2
      }
    },
    edges: {
      width: 2,
      color: {
        color: '#94a3b8',
        highlight: '#2563eb',
        hover: '#3b82f6'
      },
      smooth: {
        type: 'continuous',
        roundness: 0.5
      },
      font: {
        color: '#64748b',
        size: 11,
        strokeWidth: 0
      }
    },
    groups: {
      'control-plane': {
        color: {
          background: '#2563eb',
          border: '#1e40af',
          highlight: { background: '#3b82f6', border: '#2563eb' }
        },
        shape: 'box',
        borderWidth: 3,
        font: { color: '#ffffff' }
      },
      'monitoring': {
        color: {
          background: '#16a34a',
          border: '#15803d',
          highlight: { background: '#22c55e', border: '#16a34a' }
        },
        shape: 'box',
        borderWidth: 2,
        font: { color: '#ffffff' }
      },
      'agent': {
        color: {
          background: '#8b5cf6',
          border: '#7c3aed',
          highlight: { background: '#a78bfa', border: '#8b5cf6' }
        },
        shape: 'ellipse',
        borderWidth: 2,
        font: { color: '#ffffff' }
      },
      'application': {
        color: {
          background: '#ea580c',
          border: '#c2410c',
          highlight: { background: '#f97316', border: '#ea580c' }
        },
        shape: 'box',
        borderWidth: 2,
        font: { color: '#ffffff' }
      },
      'workload': {
        color: {
          background: '#64748b',
          border: '#475569',
          highlight: { background: '#94a3b8', border: '#64748b' }
        },
        shape: 'box',
        borderWidth: 2,
        font: { color: '#ffffff' }
      }
    },
    physics: {
      enabled: true,
      barnesHut: {
        gravitationalConstant: -3000,
        centralGravity: 0.3,
        springLength: 150,
        springConstant: 0.04,
        damping: 0.09,
        avoidOverlap: 0.5
      },
      stabilization: {
        enabled: true,
        iterations: 200,
        updateInterval: 25
      }
    },
    interaction: {
      hover: true,
      tooltipDelay: 100,
      navigationButtons: true,
      keyboard: {
        enabled: true
      },
      zoomView: true,
      dragView: true
    }
  };
  
  const network = new Network(container, data, options);
  
  // Handle node selection
  network.on('selectNode', function(params) {
    if (params.nodes.length > 0) {
      const nodeId = params.nodes[0];
      const podData = pods.find(n => n.id === nodeId);
      
      if (podData) {
        const infoPanel = document.getElementById('node-info');
        let html = `
          <h3>${podData.label}</h3>
          <p><strong>Type:</strong> ${podData.group.replace('-', ' ').toUpperCase()}</p>
          <p><strong>Physical Host:</strong> ${podData.physicalNode}</p>
          <p><strong>Host IP:</strong> ${podData.hostIP}</p>
        `;
        
        if (podData.port) {
          html += `<p><strong>Port:</strong> ${podData.port}</p>`;
        }
        
        if (podData.url) {
          html += `<p><strong>Access URL:</strong> <a href="${podData.url}" target="_blank" style="color: var(--color-primary);">${podData.url}</a></p>`;
        }
        
        if (podData.description) {
          html += `
            <div style="margin-top: 1rem;">
              <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">Description</h4>
              <p>${podData.description}</p>
            </div>
          `;
        }
        
        // Show physical node details
        const physNode = physicalNodes.find(n => n.label === podData.physicalNode);
        if (physNode) {
          html += `
            <div style="margin-top: 1rem;">
              <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">Host Node Details</h4>
              <p><strong>CPU:</strong> ${physNode.specs.cpu}</p>
              <p><strong>RAM:</strong> ${physNode.specs.ram}</p>
              <p><strong>OS:</strong> ${physNode.specs.os}</p>
              <p><strong>Status:</strong> ${physNode.status}</p>
            </div>
          `;
        }
        
        html += `
          <a href="https://github.com/JashandeepJustinBains/VMStation" target="_blank" rel="noopener noreferrer" class="btn repo-link">
            View VMStation Repo on GitHub â†’
          </a>
        `;
        
        infoPanel.innerHTML = html;
      }
    }
  });
  
  // Handle deselection
  network.on('deselectNode', function() {
    const infoPanel = document.getElementById('node-info');
    infoPanel.innerHTML = `
      <h3>Select a node to view details</h3>
      <p>Click on any server or device in the topology to see specifications and role information.</p>
    `;
  });
  
  // Control buttons
  document.getElementById('resetView')?.addEventListener('click', () => {
    network.fit({
      animation: {
        duration: 1000,
        easingFunction: 'easeInOutQuad'
      }
    });
  });
  
  let physicsEnabled = true;
  document.getElementById('togglePhysics')?.addEventListener('click', () => {
    physicsEnabled = !physicsEnabled;
    network.setOptions({ physics: { enabled: physicsEnabled } });
  });
  
  // Fit the network after stabilization
  network.once('stabilizationIterationsDone', function() {
    network.setOptions({ physics: false });
    network.fit();
  });
  }
  
  // Initialize when vis-network is loaded
  if (window.VisNetwork) {
    initializeTopology();
  } else {
    window.addEventListener('visNetworkLoaded', initializeTopology);
  }
</script>
