---


<section id="homelab">
  <h2>Homelab Network Topology</h2>
  <div class="topology-container">
    <div class="topology-header">
      <p>Interactive Kubernetes pod topology showing services and their connections across the 3-node VMStation cluster</p>
      <div class="topology-controls">
        <label class="switch">
          <input type="checkbox" id="modeSwitch" />
          <span class="slider"></span>
      justify-content: flex-start;
    }
    
    .btn-small {
      flex: 1;
    }
  }
</style>

<script>
  import { Network } from 'vis-network/standalone';
  
  // Store Network class globally for use in the data script
  window.VisNetwork = Network;
  // Dispatch event to signal that vis-network is loaded
  window.dispatchEvent(new Event('visNetworkLoaded'));
</script>

<script define:vars={{ pods, connections, physicalNodes }}>
  // Wait for vis-network to load
  function initializeTopology() {
    const Network = window.VisNetwork;
    
    if (!Network) {
      console.error('VisNetwork not loaded yet');
      return;
    }
  
  // Transform pods to vis-network format
  const nodes = pods.map(pod => ({
    id: pod.id,
    label: pod.label,
    group: pod.group,
    title: `${pod.label}\nHost: ${pod.physicalNode}\nIP: ${pod.hostIP}${pod.port ? '\nPort: ' + pod.port : ''}`,
    physicalNode: pod.physicalNode,
    physicalNodeColor: pod.physicalNodeColor,
    port: pod.port,
    url: pod.url,
    description: pod.description,
    hostIP: pod.hostIP
  }));
  
  };
  
  const network = new Network(container, data, options);
  
  // Handle node selection
  network.on('selectNode', function(params) {
    if (params.nodes.length > 0) {
      const nodeId = params.nodes[0];
      const podData = pods.find(n => n.id === nodeId);
      
      if (podData) {
        const infoPanel = document.getElementById('node-info');
        let html = `
          <h3>${podData.label}</h3>
          <p><strong>Type:</strong> ${podData.group.replace('-', ' ').toUpperCase()}</p>
          <p><strong>Physical Host:</strong> ${podData.physicalNode}</p>
          <p><strong>Host IP:</strong> ${podData.hostIP}</p>
        `;
        
        if (podData.port) {
          html += `<p><strong>Port:</strong> ${podData.port}</p>`;
        }
        
        if (podData.url) {
          html += `<p><strong>Access URL:</strong> <a href="${podData.url}" target="_blank" style="color: var(--color-primary);">${podData.url}</a></p>`;
        }
        
        if (podData.description) {
          html += `
            <div style="margin-top: 1rem;">
              <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">Description</h4>
              <p>${podData.description}</p>
            </div>
          `;
        }
        
        // Show physical node details
        const physNode = physicalNodes.find(n => n.label === podData.physicalNode);
        if (physNode) {
          html += `
            <div style="margin-top: 1rem;">
              <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">Host Node Details</h4>
              <p><strong>CPU:</strong> ${physNode.specs.cpu}</p>
              <p><strong>RAM:</strong> ${physNode.specs.ram}</p>
              <p><strong>OS:</strong> ${physNode.specs.os}</p>
              <p><strong>Status:</strong> ${physNode.status}</p>
            </div>
          `;
        }
        
        html += `
          <a href="https://github.com/JashandeepJustinBains/VMStation" target="_blank" rel="noopener noreferrer" class="btn repo-link">
            View VMStation Repo on GitHub â†’
          </a>
        `;
        
        infoPanel.innerHTML = html;
      }
    }
  });
  
  // Handle deselection
  network.on('deselectNode', function() {
    const infoPanel = document.getElementById('node-info');
    infoPanel.innerHTML = `
      <h3>Select a node to view details</h3>
      <p>Click on any server or device in the topology to see specifications and role information.</p>
    `;
  });
  
  // Control buttons
  document.getElementById('resetView')?.addEventListener('click', () => {
    network.fit({
      animation: {
        duration: 1000,
        easingFunction: 'easeInOutQuad'
      }
    });
  });
  

  // VPC overlays: draw dashed containers for each group
  function drawVPCOverlays() {
    const container = document.getElementById('network-topology-vpcs');
    if (!container) return;
    // Remove old overlays
    Array.from(container.querySelectorAll('.vpc-overlay')).forEach(e => e.remove());

    // Example: hardcoded bounding boxes for demo. In production, calculate from node positions.
    const vpcs = [
      { group: 'monitoring', label: 'Monitoring VPC', color: '#16a34a', top: 60, left: 60, width: 350, height: 300, dash: '8,8' },
      { group: 'workload', label: 'Storage VPC', color: '#64748b', top: 200, left: 500, width: 350, height: 300, dash: '8,8' },
      // Add more as needed
    ];
    vpcs.forEach(vpc => {
      const div = document.createElement('div');
      div.className = 'vpc-overlay';
      div.style.position = 'absolute';
      div.style.top = vpc.top + 'px';
      div.style.left = vpc.left + 'px';
      div.style.width = vpc.width + 'px';
      div.style.height = vpc.height + 'px';
      div.style.border = `3px dashed ${vpc.color}`;
      div.style.borderRadius = '32px';
      div.style.background = 'rgba(255,255,255,0.03)';
      div.style.pointerEvents = 'none';
      div.style.zIndex = 1;
      div.innerHTML = `<span style="position:absolute;top:-2.2em;left:0.5em;color:${vpc.color};font-weight:bold;">${vpc.label}</span>`;
      container.appendChild(div);
    });

    // Cloud tunnel effect (Azure Web Apps to compute node)
    const tunnel = document.createElement('div');
    tunnel.className = 'cloud-tunnel';
    tunnel.style.position = 'absolute';
    tunnel.style.top = '120px';
    tunnel.style.left = '410px';
    tunnel.style.width = '120px';
    tunnel.style.height = '30px';
    tunnel.style.border = '2px dotted #2563eb';
    tunnel.style.borderRadius = '20px';
    tunnel.style.background = 'rgba(37,99,235,0.08)';
    tunnel.style.zIndex = 2;
    tunnel.style.pointerEvents = 'none';
    tunnel.innerHTML = `<span style="position:absolute;top:-1.8em;left:0.5em;color:#2563eb;font-weight:bold;">Cloudflared Tunnel</span>`;
    container.appendChild(tunnel);
  }

  // Redraw overlays after vis-network renders
  setTimeout(drawVPCOverlays, 800);
  window.addEventListener('resize', drawVPCOverlays);
  
  // Fit the network after stabilization
  network.once('stabilizationIterationsDone', function() {
    network.setOptions({ physics: false });
    network.fit();
  });
  }
  
  // Initialize when vis-network is loaded
  if (window.VisNetwork) {
    initializeTopology();
  } else {
    window.addEventListener('visNetworkLoaded', initializeTopology);
  }
</script>
